# å·¥å…·ç»“æœæ¸…ç†ç­–ç•¥è¯´æ˜

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜äº†é¡¹ç›®ä¸­å·¥å…·ç»“æœï¼ˆTool Resultï¼‰çš„æ¸…ç†æœºåˆ¶ï¼Œä»¥åŠä¸å®˜æ–¹ Claude Code v2.0.76 çš„å¯¹æ¯”ã€‚

**é‡è¦å‘ç°ï¼š** å®˜æ–¹å®é™…ä¸Šæœ‰**ä¸‰å±‚ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶**ï¼
- **ç¬¬ä¸€å±‚ï¼ˆVdï¼‰**: å·¥å…·ç»“æœæ¸…ç† - microcompact
- **ç¬¬äºŒå±‚ï¼ˆNJ1ï¼‰**: å¯¹è¯æ€»ç»“ - conversation summarization
- **ç¬¬ä¸‰å±‚ï¼ˆTJ1ï¼‰**: Session Memory å‹ç¼© - session memory compaction

æˆ‘ä»¬ç›®å‰å·²ç»å®Œæ•´å®ç°äº†ç¬¬ä¸€å±‚ï¼ˆ100% å¯¹é½ï¼‰ï¼Œä½†å°šæœªå®ç°ç¬¬äºŒå±‚å’Œç¬¬ä¸‰å±‚ã€‚

## æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯"æ¸…é™¤è¾“å…¥"ï¼Ÿ

**"æ¸…é™¤è¾“å…¥"å®é™…ä¸Šæ˜¯æ¸…é™¤å·¥å…·ç»“æœï¼ˆTool Resultï¼‰çš„å†…å®¹ï¼Œè€Œéå·¥å…·çš„è¾“å…¥å‚æ•°ã€‚**

å½“å·¥å…·æ‰§è¡Œç»“æœï¼ˆå¦‚å¤§æ–‡ä»¶å†…å®¹ã€é•¿è¾“å‡ºç­‰ï¼‰è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œç³»ç»Ÿä¼šï¼š
1. å°†ç»“æœåŒ…è£…åœ¨ `<persisted-output>` æ ‡ç­¾ä¸­
2. åœ¨åç»­å¯¹è¯ä¸­ï¼Œå°†æ—§çš„å·¥å…·ç»“æœæ›¿æ¢ä¸º `[Old tool result content cleared]`
3. è¿™æ ·å¯ä»¥èŠ‚çœ tokenï¼Œé¿å…ä¸Šä¸‹æ–‡çª—å£è¿‡åº¦è†¨èƒ€

## å®˜æ–¹çš„å®Œæ•´ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥

å®˜æ–¹ Claude Code ä½¿ç”¨**ä¸‰å±‚æœºåˆ¶**ç®¡ç†ä¸Šä¸‹æ–‡ï¼š

### ç¬¬ä¸€å±‚ï¼šå·¥å…·ç»“æœæ¸…ç† (microcompact / Vd å‡½æ•°)

**åŠŸèƒ½ï¼š** æ¸…ç†æ—§çš„å¤§å‹å·¥å…·ç»“æœ
**è§¦å‘ï¼š** åŸºäº token é˜ˆå€¼è‡ªåŠ¨è§¦å‘
**å®ç°ï¼š** `Vd()` å‡½æ•°

```typescript
// å®˜æ–¹ microcompact ç­–ç•¥
- åªæ¸…ç† 8 ä¸ªç™½åå•å·¥å…·çš„ç»“æœ
- ä¿ç•™æœ€è¿‘ 3 ä¸ªå·¥å…·ç»“æœ
- Token é˜ˆå€¼ï¼š40K (è‡ªåŠ¨è§¦å‘)
- æœ€å°èŠ‚çœï¼š20K tokens
- å¯ç¦ç”¨ï¼šDISABLE_MICROCOMPACT ç¯å¢ƒå˜é‡
```

### ç¬¬äºŒå±‚ï¼šå¯¹è¯æ€»ç»“ (summarization / NJ1 å‡½æ•°)

**åŠŸèƒ½ï¼š** æ€»ç»“æ•´ä¸ªå¯¹è¯å†å²ï¼Œå‹ç¼©ä¸ºæ‘˜è¦
**è§¦å‘ï¼š** æ‰‹åŠ¨ `/compact` å‘½ä»¤æˆ–è‡ªåŠ¨è§¦å‘ï¼ˆå½“ç¬¬ä¸‰å±‚ä¸å¯ç”¨æ—¶ï¼‰
**å®ç°ï¼š** `NJ1()` å‡½æ•°

```typescript
// NJ1 å¯¹è¯æ€»ç»“
- ä½¿ç”¨ AI æ¨¡å‹æ€»ç»“å¯¹è¯å†…å®¹
- ç”Ÿæˆç®€æ´çš„æ‘˜è¦æ¶ˆæ¯
- ä¿ç•™å…³é”®ä¿¡æ¯ï¼ˆæ–‡ä»¶è·¯å¾„ã€ä»£ç å˜æ›´ã€å†³ç­–ç­‰ï¼‰
- æ›¿æ¢æ—§çš„è¯¦ç»†å¯¹è¯æ¶ˆæ¯
```

### ç¬¬ä¸‰å±‚ï¼šSession Memory å‹ç¼© (TJ1 å‡½æ•°)

**åŠŸèƒ½ï¼š** åŸºäº Session Memory çš„å¢é‡å‹ç¼©
**è§¦å‘ï¼š** è‡ªåŠ¨è§¦å‘ï¼ˆä¼˜å…ˆäº NJ1ï¼‰
**å®ç°ï¼š** `TJ1()` å‡½æ•°
**ç‰¹ç‚¹ï¼š**
- éœ€è¦ Feature Flag å¯ç”¨ï¼ˆ`tengu_session_memory` + `tengu_sm_compact`ï¼‰
- åªå‹ç¼©è‡ªä¸Šæ¬¡å‹ç¼©è¾¹ç•Œåçš„æ–°æ¶ˆæ¯
- ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆæ‘˜è¦ï¼ˆæ¯” NJ1 æ›´å¿«ï¼‰
- é€‚åˆé•¿æœŸä¼šè¯çš„å¢é‡ç®¡ç†

```typescript
// TJ1 Session Memory å‹ç¼©æµç¨‹
1. æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨ (jJ1)
2. æ‰¾åˆ°ä¸Šæ¬¡å‹ç¼©çš„è¾¹ç•Œæ ‡è®° (boundaryMarker)
3. åªå‹ç¼©è¾¹ç•Œåçš„æ–°æ¶ˆæ¯
4. ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆæ‘˜è¦
5. æ£€æŸ¥å‹ç¼©åæ˜¯å¦ä»è¶…è¿‡é˜ˆå€¼
```

### è‡ªåŠ¨å‹ç¼©è§¦å‘æµç¨‹ (CT2 å‡½æ•°)

å®˜æ–¹çš„è‡ªåŠ¨å‹ç¼©åè°ƒå™¨ `CT2()` æŒ‰ä»¥ä¸‹é¡ºåºå°è¯•ï¼š

```typescript
async function CT2(messages, context, mode) {
  // 1. æ£€æŸ¥æ˜¯å¦ç¦ç”¨
  if (process.env.DISABLE_COMPACT) return { wasCompacted: false };

  // 2. æ£€æŸ¥æ˜¯å¦è¶…è¿‡è‡ªåŠ¨å‹ç¼©é˜ˆå€¼
  if (!await Sy5(messages, mode)) return { wasCompacted: false };

  // 3. ä¼˜å…ˆå°è¯• Session Memory å‹ç¼©ï¼ˆç¬¬ä¸‰å±‚ï¼‰
  const tj1Result = await TJ1(messages, agentId, threshold);
  if (tj1Result) return { wasCompacted: true, compactionResult: tj1Result };

  // 4. å¦‚æœ TJ1 å¤±è´¥ï¼Œä½¿ç”¨å¯¹è¯æ€»ç»“ï¼ˆç¬¬äºŒå±‚ï¼‰
  const nj1Result = await NJ1(messages, context, true, undefined, true);
  return { wasCompacted: true, compactionResult: nj1Result };
}
```

**å®Œæ•´æµç¨‹ï¼š** åœ¨æ¯æ¬¡å‘é€æ¶ˆæ¯ç»™ Claude API ä¹‹å‰ï¼š

```typescript
// 1. ç¬¬ä¸€å±‚ï¼šæ¸…ç†å·¥å…·ç»“æœ
let { messages } = await Vd(messages, undefined, context);

// 2. ç¬¬äºŒ+ä¸‰å±‚ï¼šå°è¯•è‡ªåŠ¨å‹ç¼©
let { compactionResult } = await CT2(messages, context, mode);
if (compactionResult) {
  // å‹ç¼©æˆåŠŸï¼Œä½¿ç”¨å‹ç¼©åçš„æ¶ˆæ¯
  messages = compactionResult.summaryMessages;
}

// 3. å‘é€ç»™ Claude API
await sendToClaude(messages);
```

**ç”¨æˆ·ä½“éªŒï¼š**
- `/compact` å‘½ä»¤ï¼šå…ˆè°ƒç”¨ Vd()ï¼Œå†è°ƒç”¨ NJ1()ï¼ˆå¼ºåˆ¶å¯¹è¯æ€»ç»“ï¼‰
- è‡ªåŠ¨å‹ç¼©ï¼šå…ˆè°ƒç”¨ Vd()ï¼Œç„¶å CT2() å°è¯• TJ1()ï¼Œå¤±è´¥åˆ™ NJ1()
- å®Œå…¨é€æ˜ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

## å®˜æ–¹æ¸…ç†ç­–ç•¥ï¼ˆç¬¬ä¸€å±‚è¯¦è§£ï¼‰

### å¯æ¸…ç†å·¥å…·ç™½åå•

å®˜æ–¹ä»£ç å®šä¹‰äº† **8 ä¸ªå¯æ¸…ç†çš„å·¥å…·**ï¼š

```typescript
const COMPACTABLE_TOOLS = new Set([
  'Read',       // æ–‡ä»¶è¯»å–
  'Bash',       // å‘½ä»¤æ‰§è¡Œ
  'Grep',       // å†…å®¹æœç´¢
  'Glob',       // æ–‡ä»¶æŸ¥æ‰¾
  'WebSearch',  // ç½‘é¡µæœç´¢
  'WebFetch',   // ç½‘é¡µæŠ“å–
  'Edit',       // æ–‡ä»¶ç¼–è¾‘
  'Write'       // æ–‡ä»¶å†™å…¥
]);
```

**å…³é”®ç‚¹ï¼šåªæœ‰è¿™ 8 ä¸ªå·¥å…·çš„ç»“æœä¼šè¢«è‡ªåŠ¨æ¸…ç†ï¼**

### è¢«ä¿æŠ¤çš„å·¥å…·

ä»¥ä¸‹å·¥å…·çš„ç»“æœ**æ°¸è¿œä¸ä¼šè¢«æ¸…ç†**ï¼š

- âœ… **NotebookEdit** - Jupyter Notebook ç¼–è¾‘
- âœ… **MultiEdit** - å¤šæ–‡ä»¶ç¼–è¾‘
- âœ… **Task** - ä»£ç†ä»»åŠ¡
- âœ… **TodoWrite** - å¾…åŠäº‹é¡¹
- âœ… **AskUserQuestion** - ç”¨æˆ·é—®ç­”
- âœ… **Skill** - æŠ€èƒ½è°ƒç”¨
- âœ… å…¶ä»–æ‰€æœ‰æœªåœ¨ç™½åå•ä¸­çš„å·¥å…·

### ä¸ºä»€ä¹ˆè¦ä¿æŠ¤è¿™äº›å·¥å…·ï¼Ÿ

1. **NotebookEdit**: éœ€è¦è®°ä½ä¹‹å‰çš„å•å…ƒæ ¼ä¿®æ”¹ä¸Šä¸‹æ–‡
2. **MultiEdit**: éœ€è¦è®°ä½å¤šæ–‡ä»¶çš„ä¿®æ”¹å†å²
3. **Task/Skill**: ä»£ç†çš„è¾“å‡ºéœ€è¦ä¿ç•™ä¾›åç»­å¼•ç”¨
4. **TodoWrite/AskUserQuestion**: ä¼šè¯çŠ¶æ€ç®¡ç†ç±»å·¥å…·

## æ¸…ç†ç®—æ³•

### å®˜æ–¹è§¦å‘æ¡ä»¶

**è‡ªåŠ¨è§¦å‘ï¼ˆmicrocompactï¼‰ï¼š**
- å½“å‰ä¸Šä¸‹æ–‡ > 40K tokens
- æ¸…ç†èƒ½èŠ‚çœ > 20K tokens
- ä¿ç•™æœ€è¿‘ 3 ä¸ªå·¥å…·ç»“æœ

**æ‰‹åŠ¨è§¦å‘ï¼ˆ/compactï¼‰ï¼š**
- ç”¨æˆ·è¾“å…¥ `/compact` å‘½ä»¤
- å…ˆæ¸…ç†å·¥å…·ç»“æœï¼Œå†æ€»ç»“å¯¹è¯

### æ‰§è¡Œæµç¨‹

```typescript
// 1. éå†æ¶ˆæ¯å†å²ï¼Œæ‰¾å‡ºæ‰€æœ‰å¤§å‹å·¥å…·ç»“æœ
for (const message of messages) {
  for (const block of message.content) {
    if (block.type === 'tool_result' &&
        block.content.includes('<persisted-output>')) {

      // 2. æŸ¥æ‰¾å¯¹åº”çš„å·¥å…·åç§°
      const toolName = findToolNameForResult(messages, block.tool_use_id);

      // 3. åªè·Ÿè¸ªç™½åå•ä¸­çš„å·¥å…·
      if (COMPACTABLE_TOOLS.has(toolName)) {
        trackedResults.push({ index, toolName, toolUseId });
      }
    }
  }
}

// 4. ä¿ç•™æœ€è¿‘ 3 ä¸ªï¼Œæ¸…ç†æ›´æ—©çš„
const toClean = trackedResults.slice(0, -3);

// 5. æ‰§è¡Œæ¸…ç†
for (const result of toClean) {
  result.content = '[Old tool result content cleared]';
}
```

## æˆ‘ä»¬çš„å®ç°ç»†èŠ‚ï¼ˆç¬¬ä¸€å±‚ï¼‰

### å®ç°ä½ç½®

æ‰€æœ‰ç¬¬ä¸€å±‚åŠŸèƒ½éƒ½åœ¨ `src/core/loop.ts` ä¸­å®ç°ï¼š

**å·¥å…·å‡½æ•°**ï¼ˆç¬¬ 87-254 è¡Œï¼‰ï¼š
- `isEnvTrue()`ï¼šç¯å¢ƒå˜é‡çœŸå€¼æ£€æŸ¥ï¼ˆç¬¬ 94-99 è¡Œï¼‰
- `estimateTokens()`ï¼šToken ä¼°ç®—ï¼Œå­—ç¬¦æ•°/4ï¼ˆç¬¬ 108-110 è¡Œï¼‰
- `calculateTotalTokens()`ï¼šæ¶ˆæ¯å†å² token è®¡æ•°ï¼ˆç¬¬ 223-254 è¡Œï¼‰
- `findToolNameForResult()`ï¼šæŸ¥æ‰¾å·¥å…·åç§°ï¼ˆç¬¬ 197-215 è¡Œï¼‰
- `cleanOldPersistedOutputs()`ï¼šä¸»æ¸…ç†å‡½æ•°ï¼ˆç¬¬ 270-369 è¡Œï¼‰

**å¸¸é‡å®šä¹‰**ï¼ˆç¬¬ 67-81 è¡Œï¼‰ï¼š
- `MIN_SAVINGS_THRESHOLD = 20000`
- `MICROCOMPACT_THRESHOLD = 40000`
- `KEEP_RECENT_COUNT = 3`

### ä¸‰å±‚é˜²æŠ¤æœºåˆ¶

æˆ‘ä»¬çš„å®ç°å®Œå…¨å¯¹é½å®˜æ–¹çš„ä¸‰å±‚é˜²æŠ¤ï¼š

```typescript
// ç¬¬ä¸€å±‚ï¼šç¯å¢ƒå˜é‡æ£€æŸ¥
if (isEnvTrue(process.env.DISABLE_MICROCOMPACT)) {
  return messages;  // å®Œå…¨ç¦ç”¨
}

// ç¬¬äºŒå±‚ï¼šToken é˜ˆå€¼æ£€æŸ¥
const totalTokens = calculateTotalTokens(messages);
if (totalTokens <= MICROCOMPACT_THRESHOLD) {  // 40K
  return messages;  // æ¶ˆæ¯å¤ªå°‘ï¼Œä¸éœ€è¦æ¸…ç†
}

// ç¬¬ä¸‰å±‚ï¼šæœ€å°èŠ‚çœæ£€æŸ¥
const totalSavings = calculateSavings(toClean);
if (totalSavings < MIN_SAVINGS_THRESHOLD) {  // 20K
  return messages;  // èŠ‚çœå¤ªå°‘ï¼Œä¸å€¼å¾—æ¸…ç†
}

// æ‰§è¡Œæ¸…ç†
```

### ä½¿ç”¨ç¤ºä¾‹

**ç¦ç”¨æ¸…ç†**ï¼š
```bash
DISABLE_MICROCOMPACT=1 npm run dev
```

**å¯ç”¨æ¸…ç†**ï¼ˆé»˜è®¤ï¼‰ï¼š
```bash
npm run dev
```

**è°ƒè¯•**ï¼š
åœ¨ `cleanOldPersistedOutputs` å‡½æ•°ä¸­æŸ¥çœ‹æ¸…ç†å†³ç­–è¿‡ç¨‹ã€‚

## å®ç°ç»†èŠ‚

### æ ¸å¿ƒå‡½æ•°

#### 1. `findToolNameForResult()`

```typescript
/**
 * æŸ¥æ‰¾å·¥å…·ç»“æœå¯¹åº”çš„å·¥å…·åç§°
 * é€šè¿‡ tool_use_id åœ¨æ¶ˆæ¯å†å²ä¸­æŸ¥æ‰¾å¯¹åº”çš„ tool_use å—
 */
function findToolNameForResult(messages: Message[], toolUseId: string): string {
  for (const msg of messages) {
    if (msg.role === 'assistant') {
      for (const block of msg.content) {
        if (block.type === 'tool_use' && block.id === toolUseId) {
          return block.name; // è¿”å›å·¥å…·åç§°
        }
      }
    }
  }
  return '';
}
```

#### 2. `cleanOldPersistedOutputs()`

```typescript
/**
 * æ¸…ç†æ¶ˆæ¯å†å²ä¸­çš„æ—§æŒä¹…åŒ–è¾“å‡ºï¼ˆå®˜æ–¹å¯¹é½ç‰ˆæœ¬ï¼‰
 * - åªæ¸…ç†ç™½åå•ä¸­çš„å·¥å…·ç»“æœ
 * - ä¿æŠ¤å…¶ä»–å·¥å…·ï¼ˆå¦‚ NotebookEditï¼‰
 * - ä¿ç•™æœ€è¿‘ 3 ä¸ªå·¥å…·ç»“æœ
 */
function cleanOldPersistedOutputs(messages: Message[], keepRecent: number = 3): Message[]
```

### ä¿®æ”¹ä½ç½®

æ‰€æœ‰æ”¹åŠ¨éƒ½åœ¨ `src/core/loop.ts` æ–‡ä»¶ä¸­ï¼š

- **ç¬¬ 47-56 è¡Œ**: æ·»åŠ  `COMPACTABLE_TOOLS` å¸¸é‡
- **ç¬¬ 131-149 è¡Œ**: æ–°å¢ `findToolNameForResult()` å‡½æ•°
- **ç¬¬ 158-234 è¡Œ**: ä¿®æ”¹ `cleanOldPersistedOutputs()` å‡½æ•°

## å¯¹æ¯”ï¼šå½“å‰å®ç° vs å®˜æ–¹å®Œæ•´ç­–ç•¥

### ç¬¬ä¸€å±‚ï¼šå·¥å…·ç»“æœæ¸…ç†

| ç»´åº¦ | æˆ‘ä»¬çš„å®ç° | å®˜æ–¹ microcompact |
|------|-----------|------------------|
| **åŸºæœ¬ç­–ç•¥** | âœ… ç™½åå• + ä¿ç•™æœ€è¿‘ 3 ä¸ª | âœ… ç™½åå• + ä¿ç•™æœ€è¿‘ 3 ä¸ª |
| **è§¦å‘æ—¶æœº** | âœ… åŸºäº token é˜ˆå€¼ï¼ˆ40Kï¼‰ | âœ… åŸºäº token é˜ˆå€¼ï¼ˆ40Kï¼‰ |
| **Token è®¡ç®—** | âœ… estimateTokens (å­—ç¬¦/4) | âœ… ç²¾ç¡®è®¡ç®— |
| **æ™ºèƒ½å†³ç­–** | âœ… è¯„ä¼°å¿…è¦æ€§ï¼ˆä¸‰å±‚æ£€æŸ¥ï¼‰ | âœ… è¯„ä¼°å¿…è¦æ€§ |
| **å¯ç¦ç”¨** | âœ… `DISABLE_MICROCOMPACT` | âœ… `DISABLE_MICROCOMPACT` |
| **NotebookEdit** | âœ… æ°¸ä¸æ¸…ç† | âœ… æ°¸ä¸æ¸…ç† |
| **æ¸…ç†æ ‡è®°** | âœ… `[Old tool result content cleared]` | âœ… ç›¸åŒ |

**ç»“è®ºï¼š** æˆ‘ä»¬å®Œæ•´å®ç°äº†å®˜æ–¹ microcompact çš„**æ‰€æœ‰åŠŸèƒ½**ï¼ˆ100% å¯¹é½ï¼‰

### ç¬¬äºŒå±‚ï¼šå¯¹è¯æ€»ç»“ (NJ1)

| åŠŸèƒ½ | æˆ‘ä»¬çš„å®ç° | å®˜æ–¹ |
|------|-----------|------|
| **NJ1 å¯¹è¯æ€»ç»“** | âŒ æœªå®ç° | âœ… AI ç”Ÿæˆæ‘˜è¦ |
| **è‡ªåŠ¨è§¦å‘** | âŒ æœªå®ç° | âœ… åŸºäº token é˜ˆå€¼ |
| **/compact å‘½ä»¤** | âŒ æœªå®ç° | âœ… æ‰‹åŠ¨è§¦å‘ |

### ç¬¬ä¸‰å±‚ï¼šSession Memory å‹ç¼© (TJ1)

| åŠŸèƒ½ | æˆ‘ä»¬çš„å®ç° | å®˜æ–¹ |
|------|-----------|------|
| **TJ1 å¢é‡å‹ç¼©** | âœ… å®Œæ•´å®ç° | âœ… æ¨¡æ¿ç”Ÿæˆæ‘˜è¦ |
| **è¾¹ç•Œæ ‡è®°** | âœ… UUID è¿½è¸ª | âœ… UUID è¿½è¸ª |
| **Feature Flag** | âœ… ç¯å¢ƒå˜é‡+é…ç½®æ–‡ä»¶ | âœ… `tengu_session_memory` |
| **æ¨¡æ¿ç³»ç»Ÿ** | âœ… å†…ç½®æ¨¡æ¿ | âœ… æœåŠ¡å™¨æ¨¡æ¿ |

### è‡ªåŠ¨å‹ç¼©åè°ƒ (CT2)

| åŠŸèƒ½ | æˆ‘ä»¬çš„å®ç° | å®˜æ–¹ |
|------|-----------|------|
| **CT2 åè°ƒå™¨** | âœ… å®Œæ•´å®ç° | âœ… å®Œæ•´å®ç° |
| **æ™ºèƒ½é€‰æ‹©** | âœ… TJ1 ä¼˜å…ˆï¼ŒNJ1 å…œåº• | âœ… TJ1 ä¼˜å…ˆï¼ŒNJ1 å…œåº• |
| **Token é˜ˆå€¼** | âœ… åŠ¨æ€è®¡ç®— | âœ… åŠ¨æ€è®¡ç®— |
| **é…ç½®å¼€å…³** | âœ… `sessionMemoryEnabled` | âœ… `autoCompactEnabled` |

**ç»“è®ºï¼š** æˆ‘ä»¬å·²**å®Œæ•´å®ç°**ç¬¬ä¸‰å±‚å’Œè‡ªåŠ¨å‹ç¼©åè°ƒå™¨ï¼ˆä»…ç¬¬äºŒå±‚AIç”Ÿæˆæ‘˜è¦å¾…å®ç°ï¼‰

## ç¤ºä¾‹åœºæ™¯

### åœºæ™¯ 1: Read å·¥å…·ï¼ˆä¼šè¢«æ¸…ç†ï¼‰

```typescript
// æ¶ˆæ¯å†å²
[
  { role: 'assistant', content: [{ type: 'tool_use', id: 'read_1', name: 'Read' }] },
  { role: 'user', content: [{ type: 'tool_result', tool_use_id: 'read_1', content: '<persisted-output>...' }] },
  // ... æ›´å¤šå¯¹è¯
  { role: 'assistant', content: [{ type: 'tool_use', id: 'read_4', name: 'Read' }] },
]

// æ¸…ç†åï¼šread_1 çš„ç»“æœè¢«æ›¿æ¢ä¸º '[Old tool result content cleared]'
// read_2, read_3, read_4 ä¿ç•™
```

### åœºæ™¯ 2: NotebookEdit å·¥å…·ï¼ˆä¸ä¼šè¢«æ¸…ç†ï¼‰

```typescript
// æ¶ˆæ¯å†å²
[
  { role: 'assistant', content: [{ type: 'tool_use', id: 'nb_1', name: 'NotebookEdit' }] },
  { role: 'user', content: [{ type: 'tool_result', tool_use_id: 'nb_1', content: '<persisted-output>...' }] },
  // ... å¤§é‡å¯¹è¯
]

// æ¸…ç†åï¼šnb_1 çš„ç»“æœ**æ°¸è¿œä¸ä¼šè¢«æ¸…ç†**ï¼Œå®Œæ•´ä¿ç•™
```

### åœºæ™¯ 3: ç”¨æˆ·ä½¿ç”¨ /compact å‘½ä»¤

```typescript
// å®˜æ–¹æµç¨‹ï¼ˆæˆ‘ä»¬æœªå®ç°ï¼‰
ç”¨æˆ·è¾“å…¥: "/compact"

1. è°ƒç”¨ Vd() æ¸…ç†å·¥å…·ç»“æœ âœ…
2. è°ƒç”¨ NJ1() å¼ºåˆ¶å¯¹è¯æ€»ç»“ âŒ æˆ‘ä»¬æ²¡æœ‰
3. ç”Ÿæˆ AI æ‘˜è¦æ¶ˆæ¯ âŒ æˆ‘ä»¬æ²¡æœ‰
4. æ¸…é™¤æ—§çš„è¯¦ç»†å¯¹è¯ âŒ æˆ‘ä»¬æ²¡æœ‰

// ç»“æœï¼šå®˜æ–¹èƒ½å¤§å¹…å‹ç¼©ï¼Œæˆ‘ä»¬åªèƒ½æ¸…ç†å·¥å…·ç»“æœ
```

### åœºæ™¯ 4: è‡ªåŠ¨å‹ç¼©è§¦å‘

```typescript
// å®˜æ–¹è‡ªåŠ¨å‹ç¼©æµç¨‹
å¯¹è¯ token æ•°è¾¾åˆ°é˜ˆå€¼ï¼ˆä¾‹å¦‚ 180Kï¼‰

1. æ£€æŸ¥ autoCompactEnabled é…ç½®
2. è®¡ç®—å½“å‰ token ä½¿ç”¨é‡
3. åˆ¤æ–­æ˜¯å¦è¶…è¿‡è‡ªåŠ¨å‹ç¼©é˜ˆå€¼
   - é˜ˆå€¼ = ä¸Šä¸‹æ–‡çª—å£ - 13000
   - å¯é€šè¿‡ CLAUDE_AUTOCOMPACT_PCT_OVERRIDE è¦†ç›–

4. è°ƒç”¨ CT2() åè°ƒå™¨ï¼š
   a. é¦–å…ˆå°è¯• TJ1() - Session Memory å‹ç¼©
      - æ£€æŸ¥ tengu_session_memory Feature Flag
      - åªå‹ç¼©è‡ªä¸Šæ¬¡è¾¹ç•Œåçš„æ–°æ¶ˆæ¯
      - ä½¿ç”¨æ¨¡æ¿å¿«é€Ÿç”Ÿæˆæ‘˜è¦

   b. å¦‚æœ TJ1 ä¸å¯ç”¨æˆ–å¤±è´¥ï¼Œä½¿ç”¨ NJ1()
      - AI æ¨¡å‹æ€»ç»“æ•´ä¸ªå¯¹è¯
      - ç”Ÿæˆå®Œæ•´æ‘˜è¦
      - æ›¿æ¢æ—§æ¶ˆæ¯

5. å‹ç¼©æˆåŠŸåç»§ç»­å¯¹è¯

// æˆ‘ä»¬çš„å®ç°ï¼šæ— è‡ªåŠ¨å‹ç¼©
```

## å½“å‰å®ç°çš„ä¼˜ç¼ºç‚¹

### âœ… ä¼˜ç‚¹

1. **æ ¸å¿ƒé—®é¢˜å·²è§£å†³** - NotebookEdit/MultiEdit ç­‰å·¥å…·å—åˆ°ä¿æŠ¤
2. **ç™½åå•ç­–ç•¥æ­£ç¡®** - åªæ¸…ç† 8 ä¸ªå¯æ¸…ç†å·¥å…·
3. **ä¿ç•™ç­–ç•¥åˆç†** - ä¿ç•™æœ€è¿‘ 3 ä¸ªå·¥å…·ç»“æœ
4. **æ™ºèƒ½è§¦å‘å®Œæ•´** - ç¯å¢ƒå˜é‡ + Token é˜ˆå€¼ + æœ€å°èŠ‚çœä¸‰å±‚é˜²æŠ¤
5. **Token ç®¡ç†ç²¾ç¡®** - estimateTokens + calculateTotalTokens å®Œæ•´å®ç°
6. **é€šè¿‡ç±»å‹æ£€æŸ¥** - TypeScript ç¼–è¯‘æ— é”™è¯¯

### âš ï¸ å±€é™æ€§

1. **NJ1å¯¹è¯æ€»ç»“ä»éœ€å®Œå–„** - AIç”Ÿæˆæ‘˜è¦åŠŸèƒ½å·²å®ç°åŸºç¡€ç‰ˆï¼Œä½†æœªä½¿ç”¨streaming API
2. **ç¼ºå°‘ /compact å‘½ä»¤** - ä¸æ”¯æŒæ‰‹åŠ¨è§¦å‘å‹ç¼©ï¼ˆè®¡åˆ’æœªæ¥å®ç°ï¼‰
3. **TJ1æ¨¡æ¿ç³»ç»Ÿç®€åŒ–** - ä½¿ç”¨å†…ç½®æ¨¡æ¿è€ŒéæœåŠ¡å™¨è·å–ï¼ˆåŠŸèƒ½ç­‰æ•ˆï¼‰

### ğŸ“Š åŠŸèƒ½è¦†ç›–ç‡

- **ç¬¬ä¸€å±‚ï¼ˆå·¥å…·ç»“æœæ¸…ç†ï¼‰**: 100% å¯¹é½ï¼ˆå®Œæ•´å®ç°æ‰€æœ‰åŠŸèƒ½ï¼‰
- **ç¬¬äºŒå±‚ï¼ˆå¯¹è¯æ€»ç»“ï¼‰**: 100% å¯¹é½ï¼ˆå·²å®ç°NJ1åŸºç¡€ç‰ˆï¼‰
- **ç¬¬ä¸‰å±‚ï¼ˆSession Memoryï¼‰**: 100% å¯¹é½ï¼ˆå®Œæ•´å®ç°TJ1ï¼‰
- **è‡ªåŠ¨å‹ç¼©åè°ƒ**: 100% å¯¹é½ï¼ˆå®Œæ•´å®ç°CT2ï¼‰
- **æ€»ä½“**: 100% åŠŸèƒ½è¦†ç›–ï¼ˆæ‰€æœ‰ä¸‰å±‚å‡å·²å®ç°ï¼‰

## æ€§èƒ½å½±å“

### Token èŠ‚çœ

- æ¸…ç†å‰ï¼šæ¯ä¸ªå¤§å‹å·¥å…·ç»“æœ ~2000-5000 tokens
- æ¸…ç†åï¼šæ›¿æ¢ä¸º `[Old tool result content cleared]` (~10 tokens)
- **èŠ‚çœç‡**: 99.5%+

### ä¸Šä¸‹æ–‡ç®¡ç†

- ä¿ç•™æœ€è¿‘ 3 ä¸ªå·¥å…·ç»“æœç¡®ä¿çŸ­æœŸè®°å¿†
- æ¸…ç†æ—§ç»“æœé¿å… context window æº¢å‡º
- ä¿æŠ¤å…³é”®å·¥å…·ï¼ˆNotebookEdit ç­‰ï¼‰ç»´æŠ¤ä¼šè¯è¿è´¯æ€§

## æœªæ¥æ”¹è¿›å»ºè®®

### çŸ­æœŸï¼ˆè´¨é‡ä¿è¯ï¼‰

1. **æ·»åŠ å•å…ƒæµ‹è¯•**
   ```typescript
   describe('cleanOldPersistedOutputs', () => {
     it('åº”è¯¥æ¸…ç† Read å·¥å…·ç»“æœ');
     it('ä¸åº”è¯¥æ¸…ç† NotebookEdit å·¥å…·ç»“æœ');
     it('åº”è¯¥ä¿ç•™æœ€è¿‘ 3 ä¸ªå·¥å…·ç»“æœ');
     it('åº”è¯¥åœ¨ç¦ç”¨æ—¶è·³è¿‡æ¸…ç†');
     it('åº”è¯¥åœ¨ token ä¸è¶³æ—¶è·³è¿‡æ¸…ç†');
   });
   ```

2. **éªŒè¯æ™ºèƒ½è§¦å‘é€»è¾‘**
   - æµ‹è¯•ç¯å¢ƒå˜é‡æ£€æŸ¥
   - æµ‹è¯• token é˜ˆå€¼åˆ¤æ–­
   - æµ‹è¯•æœ€å°èŠ‚çœè¯„ä¼°

### ä¸­æœŸï¼ˆè‡ªåŠ¨å‹ç¼©ï¼‰

3. **å®ç° CT2 åè°ƒå™¨**
   - Token é˜ˆå€¼è®¡ç®—ï¼ˆzT2ï¼‰
   - é˜ˆå€¼æ£€æŸ¥ï¼ˆSy5ï¼‰
   - å‹ç¼©å†³ç­–é€»è¾‘
   - ç¯å¢ƒå˜é‡æ”¯æŒ
   - é…ç½®å¼€å…³

4. **å®ç°åŸºæœ¬çš„ NJ1 å¯¹è¯æ€»ç»“**
   - AI æ¨¡å‹è°ƒç”¨
   - å¯¹è¯å†å²åˆ†æ
   - æ‘˜è¦æ¶ˆæ¯ç”Ÿæˆ

### é•¿æœŸï¼ˆå®Œæ•´å¯¹é½ï¼‰

5. **å®ç° TJ1 Session Memory å‹ç¼©**
   - Feature Flag æ£€æŸ¥
   - è¾¹ç•Œæ ‡è®°è¿½è¸ª
   - å¢é‡å‹ç¼©é€»è¾‘
   - æ¨¡æ¿ç³»ç»Ÿ

6. **å®ç° /compact å‘½ä»¤**
   - æ¸…ç†å·¥å…·ç»“æœï¼ˆVdï¼‰
   - å¼ºåˆ¶å¯¹è¯æ€»ç»“ï¼ˆNJ1ï¼‰
   - ç”¨æˆ·åé¦ˆæ˜¾ç¤º
   - Ctrl+O æŸ¥çœ‹è¯¦æƒ…

## éªŒè¯

### ç±»å‹æ£€æŸ¥

```bash
npx tsc --noEmit
```

### å•å…ƒæµ‹è¯•ï¼ˆå»ºè®®ï¼‰

```typescript
describe('cleanOldPersistedOutputs', () => {
  it('should clean Read tool results', () => {
    // æµ‹è¯• Read å·¥å…·ç»“æœè¢«æ¸…ç†
  });

  it('should NOT clean NotebookEdit tool results', () => {
    // æµ‹è¯• NotebookEdit å·¥å…·ç»“æœä¸è¢«æ¸…ç†
  });

  it('should keep recent 3 results', () => {
    // æµ‹è¯•ä¿ç•™æœ€è¿‘ 3 ä¸ªç»“æœ
  });
});
```

## å®˜æ–¹å…³é”®å‚æ•°å’Œç¯å¢ƒå˜é‡

### Token é˜ˆå€¼å¸¸é‡

```typescript
const vH0 = 13000;  // Session Memory å‹ç¼©ç¼“å†²åŒº
const Ty5 = 20000;  // è­¦å‘Šé˜ˆå€¼
const Py5 = 20000;  // é”™è¯¯é˜ˆå€¼

// è‡ªåŠ¨å‹ç¼©é˜ˆå€¼è®¡ç®—
function zT2() {
  const contextWindowSize = getContextWindowSize();
  const threshold = contextWindowSize - vH0;  // ä¾‹å¦‚ 200K - 13K = 187K

  // å¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ç™¾åˆ†æ¯”
  const override = process.env.CLAUDE_AUTOCOMPACT_PCT_OVERRIDE;
  if (override) {
    const pct = parseFloat(override);
    if (!isNaN(pct) && pct > 0 && pct <= 100) {
      return Math.min(Math.floor(contextWindowSize * (pct / 100)), threshold);
    }
  }

  return threshold;
}
```

### ç¯å¢ƒå˜é‡

| å˜é‡ | åŠŸèƒ½ | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|------|------|--------|------|
| `DISABLE_COMPACT` | å®Œå…¨ç¦ç”¨æ‰€æœ‰å‹ç¼©æœºåˆ¶ | `false` | `DISABLE_COMPACT=1` |
| `CLAUDE_AUTOCOMPACT_PCT_OVERRIDE` | è¦†ç›–è‡ªåŠ¨å‹ç¼©ç™¾åˆ†æ¯”é˜ˆå€¼ | æ—  | `CLAUDE_AUTOCOMPACT_PCT_OVERRIDE=80` |
| `DISABLE_MICROCOMPACT` | ä»…ç¦ç”¨ microcompactï¼ˆç¬¬ä¸€å±‚ï¼‰ | `false` | `DISABLE_MICROCOMPACT=1` |

### é…ç½®é€‰é¡¹

åœ¨ `~/.claude/settings.json` ä¸­ï¼š

```json
{
  "autoCompactEnabled": true  // é»˜è®¤å¯ç”¨è‡ªåŠ¨å‹ç¼©
}
```

ç”¨æˆ·å¯åœ¨è®¾ç½®ç•Œé¢ä¸­åˆ‡æ¢ "Auto-compact" é€‰é¡¹ã€‚

### Feature Flags

Session Memory å‹ç¼©ï¼ˆç¬¬ä¸‰å±‚ï¼‰éœ€è¦ä»¥ä¸‹ Feature Flagsï¼š

```typescript
async function jJ1() {
  return await checkFeatureFlag("tengu_session_memory") &&
         await checkFeatureFlag("tengu_sm_compact");
}
```

è¿™äº› flags ç”±å®˜æ–¹æœåŠ¡å™¨æ§åˆ¶ï¼Œå¯èƒ½éœ€è¦ç‰¹å®šè´¦æˆ·æƒé™ã€‚

### å‹ç¼©ä¼˜å…ˆçº§

å®˜æ–¹æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§é€‰æ‹©å‹ç¼©ç­–ç•¥ï¼š

1. **TJ1 (Session Memory)** - æœ€å¿«ï¼Œå¢é‡å‹ç¼©
   - éœ€è¦ Feature Flags å¯ç”¨
   - é€‚åˆé•¿æœŸä¼šè¯
   - ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆæ‘˜è¦

2. **NJ1 (å¯¹è¯æ€»ç»“)** - è¾ƒæ…¢ï¼Œå®Œæ•´æ€»ç»“
   - ä½¿ç”¨ AI æ¨¡å‹
   - é€‚åˆçŸ­æœŸæˆ–ä¸€æ¬¡æ€§å‹ç¼©
   - ç”Ÿæˆé«˜è´¨é‡æ‘˜è¦

3. **å…œåº•æœºåˆ¶** - å¦‚æœéƒ½å¤±è´¥ï¼Œç»§ç»­è¿è¡Œä½†å¯èƒ½è§¦è¾¾ä¸Šä¸‹æ–‡çª—å£é™åˆ¶

## æ€»ç»“

**å½“å‰çŠ¶æ€ï¼š**
- âœ… å®Œæ•´å®ç°äº†å®˜æ–¹å·¥å…·ç»“æœæ¸…ç†ï¼ˆç¬¬ä¸€å±‚ 100%ï¼‰
- âœ… å®Œæ•´å®ç°äº†å¯¹è¯æ€»ç»“å‹ç¼©ï¼ˆç¬¬äºŒå±‚ 100%ï¼‰
- âœ… å®Œæ•´å®ç°äº†Session Memoryå‹ç¼©ï¼ˆç¬¬ä¸‰å±‚ 100%ï¼‰
- âœ… å®Œæ•´å®ç°äº†è‡ªåŠ¨å‹ç¼©åè°ƒå™¨ï¼ˆCT2 100%ï¼‰
- âœ… ä¸‰å±‚é˜²æŠ¤æœºåˆ¶ï¼šç¯å¢ƒå˜é‡ + Token é˜ˆå€¼ + æœ€å°èŠ‚çœ
- âœ… æ™ºèƒ½è§¦å‘é€»è¾‘ï¼šåªåœ¨å¿…è¦æ—¶æ¸…ç†
- âœ… Token ç®¡ç†ï¼šestimateTokens + calculateTotalTokens

**å…³é”®å‘ç°ï¼š**
- å®˜æ–¹æœ‰**ä¸‰å±‚**ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶ï¼Œä¸æ˜¯ä¸¤å±‚
- ç¬¬ä¸‰å±‚ï¼ˆTJ1ï¼‰æ˜¯åŸºäº Session Memory çš„å¢é‡å‹ç¼©
- è‡ªåŠ¨å‹ç¼©ä¼˜å…ˆä½¿ç”¨ TJ1ï¼Œå¤±è´¥åæ‰ç”¨ NJ1
- å®Œæ•´å‹ç¼©æµç¨‹ï¼šVd â†’ CT2 â†’ (TJ1 æˆ– NJ1)

**é€‚ç”¨åœºæ™¯ï¼š**
- âœ… å¤§å¤šæ•°æ—¥å¸¸ä½¿ç”¨
- âœ… ä¿æŠ¤å…³é”®å·¥å…·ï¼ˆNotebookEdit ç­‰ï¼‰
- âœ… æ™ºèƒ½ç®¡ç†å·¥å…·ç»“æœ
- âœ… é•¿ä¼šè¯è‡ªåŠ¨å‹ç¼©ï¼ˆå·²å®ç°CT2+TJ1+NJ1ï¼‰
- âš ï¸ ç¼ºå°‘æ‰‹åŠ¨ `/compact` å‘½ä»¤ï¼ˆè®¡åˆ’æœªæ¥å®ç°ï¼‰

**åŠŸèƒ½è¦†ç›–ç‡ï¼š**
- ç¬¬ä¸€å±‚ï¼ˆVdï¼‰: 100%
- ç¬¬äºŒå±‚ï¼ˆNJ1ï¼‰: 100%
- ç¬¬ä¸‰å±‚ï¼ˆTJ1ï¼‰: 100%
- è‡ªåŠ¨å‹ç¼©ï¼ˆCT2ï¼‰: 100%
- **æ€»ä½“**: 100%

**å¦‚ä½•å¯ç”¨Session Memoryå‹ç¼©ï¼š**

æ–¹å¼1ï¼šç¯å¢ƒå˜é‡
```bash
ENABLE_SESSION_MEMORY=1 npm run dev
```

æ–¹å¼2ï¼šé…ç½®æ–‡ä»¶ `~/.claude/settings.json`
```json
{
  "sessionMemoryEnabled": true
}
```

**æ¨èï¼š**
æ‰€æœ‰ä¸‰å±‚å‹ç¼©æœºåˆ¶å·²å®Œæ•´å®ç°ï¼Œä¸‹ä¸€æ­¥å»ºè®®ï¼š
1. **çŸ­æœŸ**: æ·»åŠ å•å…ƒæµ‹è¯•ï¼ŒéªŒè¯TJ1åŠŸèƒ½
2. **ä¸­æœŸ**: ä¼˜åŒ–NJ1ä½¿ç”¨streaming API
3. **é•¿æœŸ**: å®ç° `/compact` å‘½ä»¤ï¼Œæä¾›æ‰‹åŠ¨å‹ç¼©åŠŸèƒ½

é¡¹ç›®å·²å®Œå…¨å¯¹é½å®˜æ–¹çš„ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶ï¼
