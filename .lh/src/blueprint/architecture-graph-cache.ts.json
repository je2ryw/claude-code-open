{
    "sourceFile": "src/blueprint/architecture-graph-cache.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1768487007316,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1768487007316,
            "name": "Commit-0",
            "content": "/**\n * 架构图缓存管理器\n *\n * 功能：\n * 1. 持久化到磁盘\n * 2. 基于蓝图ID和图表类型的缓存\n * 3. 1小时过期\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as os from 'os';\n\n// ============================================================================\n// 类型定义\n// ============================================================================\n\nexport type ArchitectureGraphType = 'dataflow' | 'sequence' | 'toolflow' | 'modulerelation' | 'full';\n\nexport interface ArchitectureGraphCacheEntry {\n  type: ArchitectureGraphType;\n  title: string;\n  description: string;\n  mermaidCode: string;\n  generatedAt: string;\n  timestamp: number;\n}\n\n// ============================================================================\n// 缓存管理器\n// ============================================================================\n\nexport class ArchitectureGraphCache {\n  private cacheDir: string;\n\n  /** 缓存过期时间（毫秒）：1小时 */\n  private readonly CACHE_EXPIRY_MS = 24 * 60 * 60 * 1000;\n\n  constructor() {\n    this.cacheDir = path.join(os.homedir(), '.claude', 'architecture-graph-cache');\n    this.ensureCacheDir();\n  }\n\n  /**\n   * 确保缓存目录存在\n   */\n  private ensureCacheDir(): void {\n    if (!fs.existsSync(this.cacheDir)) {\n      fs.mkdirSync(this.cacheDir, { recursive: true });\n    }\n  }\n\n  /**\n   * 获取缓存文件路径\n   */\n  private getCacheFilePath(blueprintId: string, graphType: ArchitectureGraphType): string {\n    // 简单清理 blueprintId 中的非法字符\n    const safeId = blueprintId.replace(/[<>:\"/\\\\|?*]/g, '_');\n    return path.join(this.cacheDir, `${safeId}-${graphType}.json`);\n  }\n\n  /**\n   * 获取缓存\n   */\n  get(blueprintId: string, graphType: ArchitectureGraphType): ArchitectureGraphCacheEntry | null {\n    const cacheFilePath = this.getCacheFilePath(blueprintId, graphType);\n\n    if (!fs.existsSync(cacheFilePath)) {\n      return null;\n    }\n\n    try {\n      const cacheData: ArchitectureGraphCacheEntry = JSON.parse(fs.readFileSync(cacheFilePath, 'utf-8'));\n\n      // 检查是否过期\n      const age = Date.now() - cacheData.timestamp;\n      if (age > this.CACHE_EXPIRY_MS) {\n        console.log(`[ArchitectureGraphCache] 缓存已过期: ${blueprintId}-${graphType}`);\n        fs.unlinkSync(cacheFilePath);\n        return null;\n      }\n\n      console.log(`[ArchitectureGraphCache] ✓ 缓存命中: ${blueprintId}-${graphType}`);\n      return cacheData;\n    } catch (error) {\n      console.error(`[ArchitectureGraphCache] 读取缓存失败: ${blueprintId}-${graphType}`, error);\n      return null;\n    }\n  }\n\n  /**\n   * 设置缓存\n   */\n  set(blueprintId: string, graphType: ArchitectureGraphType, data: ArchitectureGraphCacheEntry): void {\n    const cacheFilePath = this.getCacheFilePath(blueprintId, graphType);\n\n    try {\n      fs.writeFileSync(cacheFilePath, JSON.stringify(data, null, 2), 'utf-8');\n      console.log(`[ArchitectureGraphCache] ✓ 缓存已保存: ${blueprintId}-${graphType}`);\n    } catch (error) {\n      console.error(`[ArchitectureGraphCache] 保存缓存失败: ${blueprintId}-${graphType}`, error);\n    }\n  }\n\n  /**\n   * 删除指定蓝图的所有缓存\n   */\n  deleteByBlueprint(blueprintId: string): number {\n    let count = 0;\n    const types: ArchitectureGraphType[] = ['dataflow', 'sequence', 'toolflow', 'modulerelation', 'full'];\n\n    for (const type of types) {\n      const cacheFilePath = this.getCacheFilePath(blueprintId, type);\n      if (fs.existsSync(cacheFilePath)) {\n        try {\n          fs.unlinkSync(cacheFilePath);\n          count++;\n        } catch (error) {\n          console.error(`[ArchitectureGraphCache] 删除缓存失败: ${blueprintId}-${type}`, error);\n        }\n      }\n    }\n\n    if (count > 0) {\n      console.log(`[ArchitectureGraphCache] ✓ 已删除 ${count} 个缓存: ${blueprintId}`);\n    }\n\n    return count;\n  }\n\n  /**\n   * 清理所有缓存\n   */\n  clear(): number {\n    let count = 0;\n\n    try {\n      const files = fs.readdirSync(this.cacheDir);\n\n      for (const file of files) {\n        if (file.endsWith('.json')) {\n          fs.unlinkSync(path.join(this.cacheDir, file));\n          count++;\n        }\n      }\n\n      console.log(`[ArchitectureGraphCache] ✓ 清理了 ${count} 个缓存文件`);\n    } catch (error) {\n      console.error('[ArchitectureGraphCache] 清理缓存失败', error);\n    }\n\n    return count;\n  }\n\n  /**\n   * 清理过期缓存\n   */\n  cleanExpired(): number {\n    let count = 0;\n\n    try {\n      const files = fs.readdirSync(this.cacheDir);\n\n      for (const file of files) {\n        if (!file.endsWith('.json')) continue;\n\n        const filePath = path.join(this.cacheDir, file);\n        const cacheData: ArchitectureGraphCacheEntry = JSON.parse(fs.readFileSync(filePath, 'utf-8'));\n\n        const age = Date.now() - cacheData.timestamp;\n        if (age > this.CACHE_EXPIRY_MS) {\n          fs.unlinkSync(filePath);\n          count++;\n        }\n      }\n\n      if (count > 0) {\n        console.log(`[ArchitectureGraphCache] ✓ 清理了 ${count} 个过期缓存`);\n      }\n    } catch (error) {\n      console.error('[ArchitectureGraphCache] 清理过期缓存失败', error);\n    }\n\n    return count;\n  }\n\n  /**\n   * 获取统计信息\n   */\n  getStats(): { total: number; size: number } {\n    let total = 0;\n    let size = 0;\n\n    try {\n      const files = fs.readdirSync(this.cacheDir);\n\n      for (const file of files) {\n        if (file.endsWith('.json')) {\n          total++;\n          const filePath = path.join(this.cacheDir, file);\n          const stats = fs.statSync(filePath);\n          size += stats.size;\n        }\n      }\n    } catch (error) {\n      console.error('[ArchitectureGraphCache] 获取统计信息失败', error);\n    }\n\n    return { total, size };\n  }\n}\n\n// ============================================================================\n// 导出单例\n// ============================================================================\n\nexport const architectureGraphCache = new ArchitectureGraphCache();\n"
        }
    ]
}