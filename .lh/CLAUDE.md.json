{
    "sourceFile": "CLAUDE.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1766738180370,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766971567446,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n # CLAUDE.md\n \n This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n-\n+你的编程搭子是中国人，记得用中文回复\n ## Project Overview\n \n This is an educational reverse-engineering project that recreates Claude Code CLI v2.0.76. It's a TypeScript-based terminal application that provides an AI assistant with 25+ tools for file operations, code analysis, web access, and system commands.\n 官方源码路径：\\node_modules\\@anthropic-ai\\claude-code\n"
                }
            ],
            "date": 1766738180370,
            "name": "Commit-0",
            "content": "# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## Project Overview\n\nThis is an educational reverse-engineering project that recreates Claude Code CLI v2.0.76. It's a TypeScript-based terminal application that provides an AI assistant with 25+ tools for file operations, code analysis, web access, and system commands.\n官方源码路径：\\node_modules\\@anthropic-ai\\claude-code\n**Important:** This is NOT the official Claude Code source - it's a learning project based on public APIs and type definitions.\n\n## Development Commands\n\n### Building and Running\n```bash\n# Development mode (live TypeScript execution)\nnpm run dev\n\n# Build TypeScript to dist/\nnpm run build\n\n# Run compiled version\nnpm run start\n# or\nnode dist/cli.js\n\n# Type checking without compiling\nnpx tsc --noEmit\n\n# Install globally (optional)\nnpm link\n```\n\n### CLI Usage\n```bash\n# Interactive mode\nnode dist/cli.js\n\n# With initial prompt\nnode dist/cli.js \"Analyze this codebase\"\n\n# Print mode (non-interactive)\nnode dist/cli.js -p \"Explain this code\"\n\n# Specify model\nnode dist/cli.js -m opus \"Complex task\"\nnode dist/cli.js -m haiku \"Simple task\"\n\n# Resume last session\nnode dist/cli.js --resume\n```\n\n## Architecture Overview\n\n### Core Three-Layer Design\n\n1. **Entry Layer** (`src/cli.ts`, `src/index.ts`)\n   - CLI argument parsing with Commander.js\n   - Main export barrel file\n\n2. **Core Engine** (`src/core/`)\n   - `client.ts` - Anthropic API wrapper with retry logic, token counting, cost calculation\n   - `session.ts` - Session state management, message history, cost tracking\n   - `loop.ts` - Main conversation orchestrator, handles tool filtering and multi-turn dialogues\n\n3. **Tool System** (`src/tools/`)\n   - All tools extend `BaseTool` and register in `ToolRegistry`\n   - 25 tools including: Bash, Read, Write, Edit, MultiEdit, Glob, Grep, WebFetch, WebSearch, TodoWrite, Task, NotebookEdit, MCP integration, Tmux, Skills, etc.\n\n### Key Data Flow\n\n```\nCLI Input → ConversationLoop → ClaudeClient (Anthropic API)\n                ↓                      ↓\n           ToolRegistry           Session State\n                ↓                      ↓\n          Tool Execution    Session Persistence (~/.claude/sessions/)\n```\n\n### Important Subsystems\n\n- **Session Management** (`src/session/`) - Persists conversations to `~/.claude/sessions/` with 30-day expiry\n- **Configuration** (`src/config/`) - Loads from `~/.claude/settings.json` and environment variables\n- **Context Management** (`src/context/`) - Token estimation, auto-summarization when hitting limits\n- **Hooks System** (`src/hooks/`) - Pre/post tool execution hooks for customization\n- **Plugin System** (`src/plugins/`) - Extensible plugin architecture\n- **UI Components** (`src/ui/`) - React + Ink terminal UI framework\n- **Code Parser** (`src/parser/`) - Tree-sitter WASM for multi-language parsing\n- **Ripgrep** (`src/search/ripgrep.ts`) - Vendored ripgrep binary support\n- **Streaming I/O** (`src/streaming/`) - JSON message streaming for Claude API\n\n## TypeScript Configuration Notes\n\n- **Target:** ES2022\n- **Module System:** NodeNext (ES Modules with `import`/`export`)\n- **Strict Mode:** Enabled\n- **JSX:** React (for Ink UI components)\n- **Output:** `dist/` directory with source maps and declaration files\n\n## Configuration Locations\n\n- **API Key:** Environment variables (`ANTHROPIC_API_KEY` or `CLAUDE_API_KEY`) or `~/.claude/settings.json`\n- **Sessions:** `~/.claude/sessions/` (JSON files)\n- **MCP Servers:** Defined in `~/.claude/settings.json`\n- **Skills:** `~/.claude/skills/` and `./.claude/commands/`\n- **Plugins:** `~/.claude/plugins/` and `./.claude/plugins/`\n\n### Windows-Specific Notes\n\n- Config path: `%USERPROFILE%\\.claude\\` instead of `~/.claude/`\n- Environment variables: Use `set` (CMD) or `$env:` (PowerShell) instead of `export`\n- Bubblewrap sandbox: Linux-only (Windows users need WSL or run without sandboxing)\n- Tmux: Linux/macOS only (Windows alternative: Windows Terminal with tabs/panes)\n- Hook scripts: Use `.bat` or `.ps1` instead of `.sh`\n- JSON paths: Use double backslashes (e.g., `\"C:\\\\Users\\\\user\\\\projects\"`)\n\n## Key Design Patterns\n\n- **Registry Pattern** - `ToolRegistry` for dynamic tool management\n- **Plugin Pattern** - `PluginManager` with lifecycle hooks\n- **Strategy Pattern** - Multiple permission modes (acceptEdits, bypassPermissions, plan)\n- **Observer Pattern** - Event-driven hook system\n- **Factory Pattern** - Tool instantiation and registration\n\n## Tool System Architecture\n\nTools are the core of the application. Each tool:\n1. Extends `BaseTool` class\n2. Defines input schema with Zod\n3. Implements `execute()` method\n4. Registers in `ToolRegistry`\n5. Can be filtered via allow/disallow lists\n\nTools communicate results back to the conversation loop, which feeds them to the Claude API for the next turn.\n\n## Session Persistence\n\nSessions are automatically saved to disk with:\n- Unique UUID identifiers\n- Complete message history\n- Token and cost tracking\n- Working directory context\n- Metadata (model, timestamps)\n- 30-day expiration\n\nSessions can be resumed via `--resume` flag or session ID.\n\n## Platform Compatibility\n\nThe codebase targets Node.js 18+ and has been designed with cross-platform support:\n- Core functionality works on Windows, macOS, and Linux\n- Some features (Bubblewrap sandbox, Tmux) are platform-specific\n- Use WASM fallbacks for native modules when unavailable\n- Path handling should be cross-platform aware\n\n## Dependencies to Know\n\n**Critical:**\n- `@anthropic-ai/sdk` - Claude API client\n- `commander` - CLI framework\n- `react` + `ink` - Terminal UI\n- `tree-sitter` + `tree-sitter-wasms` - Code parsing\n- `zod` - Schema validation\n\n**Supporting:**\n- `axios` - HTTP requests (WebFetch)\n- `cheerio` - HTML parsing\n- `glob` - File pattern matching\n- `chalk` - Terminal colors\n- `marked` - Markdown rendering\n- `uuid` - Session IDs\n\n## Module Resolution\n\nThis project uses ES Modules (`\"type\": \"module\"` in package.json):\n- Use `import`/`export` syntax\n- File extensions in imports follow Node.js ESM rules\n- `tsconfig.json` uses `\"module\": \"NodeNext\"` for proper resolution\n\n## Testing Notes\n\nCurrently, there's no formal test suite. When testing manually:\n- Use `npm run dev` for quick iteration\n- Test tools individually through the CLI\n- Check session persistence in `~/.claude/sessions/`\n- Verify API key configuration before running\n- Test with different models (opus, sonnet, haiku)\n"
        }
    ]
}