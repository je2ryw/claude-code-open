<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è“å›¾ç³»ç»Ÿä»ªè¡¨æ¿ | Claude Code</title>
  <style>
    :root {
      --bg-primary: #1a1b26;
      --bg-secondary: #24283b;
      --bg-tertiary: #414868;
      --text-primary: #c0caf5;
      --text-secondary: #a9b1d6;
      --accent-blue: #7aa2f7;
      --accent-green: #9ece6a;
      --accent-red: #f7768e;
      --accent-yellow: #e0af68;
      --accent-purple: #bb9af7;
      --border-color: #414868;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* å¤´éƒ¨ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 24px;
      color: var(--accent-blue);
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: var(--bg-primary);
    }

    .btn-success {
      background: var(--accent-green);
      color: var(--bg-primary);
    }

    .btn-danger {
      background: var(--accent-red);
      color: var(--bg-primary);
    }

    .btn:hover {
      opacity: 0.8;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .stat-card h3 {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
    }

    .stat-card .value.blue { color: var(--accent-blue); }
    .stat-card .value.green { color: var(--accent-green); }
    .stat-card .value.red { color: var(--accent-red); }
    .stat-card .value.yellow { color: var(--accent-yellow); }
    .stat-card .value.purple { color: var(--accent-purple); }

    /* ä¸»å†…å®¹åŒº */
    .main-grid {
      display: grid;
      grid-template-columns: 350px 1fr 300px;
      gap: 20px;
    }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* é¢æ¿ */
    .panel {
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .panel-header {
      padding: 15px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-header h2 {
      font-size: 14px;
      font-weight: 600;
    }

    .panel-body {
      padding: 15px 20px;
      max-height: 600px;
      overflow-y: auto;
    }

    /* ä»»åŠ¡æ ‘ */
    .task-tree {
      font-size: 13px;
    }

    .tree-node {
      margin-left: 20px;
      padding: 5px 0;
    }

    .tree-node.root {
      margin-left: 0;
    }

    .node-content {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .node-content:hover {
      background: var(--bg-tertiary);
    }

    .node-icon {
      width: 20px;
      text-align: center;
    }

    .node-name {
      flex: 1;
    }

    .node-status {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      text-transform: uppercase;
    }

    .status-pending { background: var(--bg-tertiary); color: var(--text-secondary); }
    .status-coding { background: var(--accent-blue); color: var(--bg-primary); }
    .status-testing { background: var(--accent-yellow); color: var(--bg-primary); }
    .status-passed { background: var(--accent-green); color: var(--bg-primary); }
    .status-failed { background: var(--accent-red); color: var(--bg-primary); }

    /* æ—¶é—´çº¿ */
    .timeline {
      position: relative;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border-color);
    }

    .timeline-item {
      position: relative;
      padding-left: 35px;
      padding-bottom: 15px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: 5px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent-blue);
      border: 2px solid var(--bg-secondary);
    }

    .timeline-item.checkpoint::before {
      background: var(--accent-purple);
    }

    .timeline-item.error::before {
      background: var(--accent-red);
    }

    .timeline-item.success::before {
      background: var(--accent-green);
    }

    .timeline-time {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .timeline-content {
      font-size: 13px;
    }

    /* Worker åˆ—è¡¨ */
    .worker-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .worker-card {
      background: var(--bg-tertiary);
      padding: 12px;
      border-radius: 6px;
    }

    .worker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .worker-id {
      font-size: 12px;
      color: var(--accent-purple);
    }

    .worker-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .worker-task {
      font-size: 13px;
      margin-bottom: 8px;
    }

    .worker-progress {
      height: 4px;
      background: var(--bg-primary);
      border-radius: 2px;
      overflow: hidden;
    }

    .worker-progress-bar {
      height: 100%;
      background: var(--accent-green);
      transition: width 0.3s;
    }

    /* TDD å¾ªç¯æŒ‡ç¤ºå™¨ */
    .tdd-cycle {
      display: flex;
      justify-content: space-around;
      padding: 20px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .tdd-phase {
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 0.5;
    }

    .tdd-phase.active {
      opacity: 1;
    }

    .tdd-phase-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-bottom: 8px;
      background: var(--bg-secondary);
    }

    .tdd-phase.active .tdd-phase-icon {
      background: var(--accent-blue);
    }

    .tdd-phase.completed .tdd-phase-icon {
      background: var(--accent-green);
    }

    .tdd-phase-name {
      font-size: 11px;
      text-align: center;
    }

    /* æ£€æŸ¥ç‚¹åˆ—è¡¨ */
    .checkpoint-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .checkpoint-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checkpoint-item:hover {
      background: var(--border-color);
    }

    .checkpoint-icon {
      font-size: 18px;
    }

    .checkpoint-info {
      flex: 1;
    }

    .checkpoint-name {
      font-size: 13px;
      margin-bottom: 2px;
    }

    .checkpoint-time {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .checkpoint-action {
      padding: 4px 8px;
      font-size: 11px;
      background: var(--accent-purple);
      color: var(--bg-primary);
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .checkpoint-item:hover .checkpoint-action {
      opacity: 1;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: flex;
      justify-content: center;
      padding: 40px;
    }

    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <h1>ğŸ è“å›¾ç³»ç»Ÿä»ªè¡¨æ¿</h1>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
        <button class="btn btn-success" id="startBtn" onclick="toggleExecution()">â–¶ï¸ å¼€å§‹æ‰§è¡Œ</button>
        <button class="btn btn-danger" onclick="createCheckpoint()">ğŸ“Œ åˆ›å»ºæ£€æŸ¥ç‚¹</button>
      </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>æ€»ä»»åŠ¡æ•°</h3>
        <div class="value blue" id="totalTasks">--</div>
      </div>
      <div class="stat-card">
        <h3>å·²å®Œæˆ</h3>
        <div class="value green" id="passedTasks">--</div>
      </div>
      <div class="stat-card">
        <h3>æ‰§è¡Œä¸­</h3>
        <div class="value yellow" id="runningTasks">--</div>
      </div>
      <div class="stat-card">
        <h3>å¤±è´¥</h3>
        <div class="value red" id="failedTasks">--</div>
      </div>
      <div class="stat-card">
        <h3>è¿›åº¦</h3>
        <div class="value purple" id="progress">--%</div>
      </div>
      <div class="stat-card">
        <h3>æ´»è·ƒ Worker</h3>
        <div class="value blue" id="activeWorkers">--</div>
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-grid">
      <!-- å·¦ä¾§ï¼šä»»åŠ¡æ ‘ -->
      <div class="panel">
        <div class="panel-header">
          <h2>ğŸŒ³ ä»»åŠ¡æ ‘</h2>
          <span id="treeDepth">æ·±åº¦: --</span>
        </div>
        <div class="panel-body">
          <div id="taskTree" class="task-tree">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>

      <!-- ä¸­é—´ï¼šä¸»é¢æ¿ -->
      <div>
        <!-- TDD å¾ªç¯çŠ¶æ€ -->
        <div class="panel" style="margin-bottom: 20px;">
          <div class="panel-header">
            <h2>ğŸ”„ TDD å¾ªç¯çŠ¶æ€</h2>
          </div>
          <div class="panel-body">
            <div class="tdd-cycle">
              <div class="tdd-phase" id="phase-write_test">
                <div class="tdd-phase-icon">âœï¸</div>
                <div class="tdd-phase-name">ç¼–å†™æµ‹è¯•</div>
              </div>
              <div class="tdd-phase" id="phase-run_test_red">
                <div class="tdd-phase-icon">ğŸ”´</div>
                <div class="tdd-phase-name">çº¢ç¯</div>
              </div>
              <div class="tdd-phase" id="phase-write_code">
                <div class="tdd-phase-icon">ğŸ’»</div>
                <div class="tdd-phase-name">ç¼–å†™ä»£ç </div>
              </div>
              <div class="tdd-phase" id="phase-run_test_green">
                <div class="tdd-phase-icon">ğŸŸ¢</div>
                <div class="tdd-phase-name">ç»¿ç¯</div>
              </div>
              <div class="tdd-phase" id="phase-refactor">
                <div class="tdd-phase-icon">ğŸ”§</div>
                <div class="tdd-phase-name">é‡æ„</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Worker åˆ—è¡¨ -->
        <div class="panel">
          <div class="panel-header">
            <h2>ğŸ Worker èœœèœ‚ä»¬</h2>
            <span id="workerCount">0 / 5</span>
          </div>
          <div class="panel-body">
            <div id="workerList" class="worker-list">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ</div>
                <div>æš‚æ— æ´»è·ƒçš„ Worker</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šæ—¶é—´çº¿å’Œæ£€æŸ¥ç‚¹ -->
      <div>
        <!-- æ—¶é—´çº¿ -->
        <div class="panel" style="margin-bottom: 20px;">
          <div class="panel-header">
            <h2>ğŸ“œ æ—¶é—´çº¿</h2>
          </div>
          <div class="panel-body" style="max-height: 300px;">
            <div id="timeline" class="timeline">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>

        <!-- æ£€æŸ¥ç‚¹ -->
        <div class="panel">
          <div class="panel-header">
            <h2>â±ï¸ æ—¶å…‰å€’æµ</h2>
          </div>
          <div class="panel-body">
            <div id="checkpointList" class="checkpoint-list">
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“Œ</div>
                <div>æš‚æ— æ£€æŸ¥ç‚¹</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API åŸºç¡€è·¯å¾„
    const API_BASE = '/api/blueprint';

    // çŠ¶æ€
    let isRunning = false;
    let currentTreeId = null;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      refreshData();
      // æ¯ 5 ç§’åˆ·æ–°
      setInterval(refreshData, 5000);
    });

    // åˆ·æ–°æ•°æ®
    async function refreshData() {
      try {
        const response = await fetch(`${API_BASE}/coordinator/dashboard`);
        const result = await response.json();

        if (result.success && result.data) {
          updateDashboard(result.data);
        }
      } catch (error) {
        console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
      }
    }

    // æ›´æ–°ä»ªè¡¨æ¿
    function updateDashboard(data) {
      // æ›´æ–°ç»Ÿè®¡
      if (data.stats) {
        document.getElementById('totalTasks').textContent = data.stats.totalTasks || 0;
        document.getElementById('passedTasks').textContent = data.stats.passedTasks || 0;
        document.getElementById('runningTasks').textContent = data.stats.runningTasks || 0;
        document.getElementById('failedTasks').textContent = data.stats.failedTasks || 0;
        document.getElementById('progress').textContent =
          (data.stats.progressPercentage || 0).toFixed(1) + '%';
        document.getElementById('treeDepth').textContent = `æ·±åº¦: ${data.stats.maxDepth || 0}`;
      }

      // æ›´æ–° Worker æ•°é‡
      const workers = data.workers || [];
      const activeWorkers = workers.filter(w => w.status !== 'idle').length;
      document.getElementById('activeWorkers').textContent = activeWorkers;
      document.getElementById('workerCount').textContent = `${activeWorkers} / 5`;

      // æ›´æ–°ä»»åŠ¡æ ‘
      if (data.taskTree) {
        currentTreeId = data.taskTree.id;
        renderTaskTree(data.taskTree.root);
      }

      // æ›´æ–° Worker åˆ—è¡¨
      renderWorkerList(workers);

      // æ›´æ–°æ—¶é—´çº¿
      if (data.timeline) {
        renderTimeline(data.timeline);
      }

      // æ›´æ–°æ‰§è¡ŒçŠ¶æ€
      isRunning = data.queen?.status === 'coordinating';
      updateStartButton();
    }

    // æ¸²æŸ“ä»»åŠ¡æ ‘
    function renderTaskTree(node, container = null) {
      if (!container) {
        container = document.getElementById('taskTree');
        container.innerHTML = '';
      }

      const nodeEl = document.createElement('div');
      nodeEl.className = `tree-node ${node.depth === 0 ? 'root' : ''}`;

      const statusClass = `status-${node.status}`;
      const icon = getStatusIcon(node.status);

      nodeEl.innerHTML = `
        <div class="node-content" onclick="selectTask('${node.id}')">
          <span class="node-icon">${icon}</span>
          <span class="node-name">${node.name}</span>
          <span class="node-status ${statusClass}">${node.status}</span>
        </div>
      `;

      container.appendChild(nodeEl);

      // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
      if (node.children && node.children.length > 0) {
        const childContainer = document.createElement('div');
        childContainer.style.marginLeft = '20px';
        for (const child of node.children) {
          renderTaskTree(child, childContainer);
        }
        nodeEl.appendChild(childContainer);
      }
    }

    // è·å–çŠ¶æ€å›¾æ ‡
    function getStatusIcon(status) {
      const icons = {
        pending: 'â³',
        blocked: 'ğŸš«',
        test_writing: 'âœï¸',
        coding: 'ğŸ’»',
        testing: 'ğŸ§ª',
        test_failed: 'âŒ',
        passed: 'âœ…',
        review: 'ğŸ‘€',
        approved: 'âœ…',
        rejected: 'âŒ',
        cancelled: 'ğŸš«',
      };
      return icons[status] || 'â“';
    }

    // æ¸²æŸ“ Worker åˆ—è¡¨
    function renderWorkerList(workers) {
      const container = document.getElementById('workerList');

      if (!workers || workers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ</div>
            <div>æš‚æ— æ´»è·ƒçš„ Worker</div>
          </div>
        `;
        return;
      }

      container.innerHTML = workers.map(worker => {
        const progress = worker.tddCycle ?
          ((worker.tddCycle.iteration / worker.tddCycle.maxIterations) * 100) : 0;

        return `
          <div class="worker-card">
            <div class="worker-header">
              <span class="worker-id">${worker.id.substring(0, 8)}...</span>
              <span class="worker-status status-${worker.status}">${worker.status}</span>
            </div>
            <div class="worker-task">${worker.taskId ? 'ä»»åŠ¡: ' + worker.taskId.substring(0, 8) + '...' : 'ç©ºé—²'}</div>
            <div class="worker-progress">
              <div class="worker-progress-bar" style="width: ${progress}%"></div>
            </div>
          </div>
        `;
      }).join('');

      // æ›´æ–° TDD é˜¶æ®µé«˜äº®
      const activeWorker = workers.find(w => w.status !== 'idle');
      if (activeWorker && activeWorker.tddCycle) {
        updateTDDPhase(activeWorker.tddCycle.phase);
      }
    }

    // æ›´æ–° TDD é˜¶æ®µ
    function updateTDDPhase(phase) {
      const phases = ['write_test', 'run_test_red', 'write_code', 'run_test_green', 'refactor'];
      phases.forEach(p => {
        const el = document.getElementById(`phase-${p}`);
        if (el) {
          el.classList.remove('active', 'completed');
          if (p === phase) {
            el.classList.add('active');
          } else if (phases.indexOf(p) < phases.indexOf(phase)) {
            el.classList.add('completed');
          }
        }
      });
    }

    // æ¸²æŸ“æ—¶é—´çº¿
    function renderTimeline(events) {
      const container = document.getElementById('timeline');

      if (!events || events.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“œ</div>
            <div>æš‚æ— äº‹ä»¶</div>
          </div>
        `;
        return;
      }

      // åªæ˜¾ç¤ºæœ€è¿‘ 20 æ¡
      const recentEvents = events.slice(-20).reverse();

      container.innerHTML = recentEvents.map(event => {
        const typeClass = event.type.includes('fail') ? 'error' :
                         event.type.includes('complete') || event.type.includes('pass') ? 'success' :
                         event.type.includes('checkpoint') ? 'checkpoint' : '';

        const time = new Date(event.timestamp).toLocaleTimeString();

        return `
          <div class="timeline-item ${typeClass}">
            <div class="timeline-time">${time}</div>
            <div class="timeline-content">${event.description}</div>
          </div>
        `;
      }).join('');
    }

    // åˆ‡æ¢æ‰§è¡ŒçŠ¶æ€
    async function toggleExecution() {
      try {
        if (isRunning) {
          await fetch(`${API_BASE}/coordinator/stop`, { method: 'POST' });
        } else {
          await fetch(`${API_BASE}/coordinator/start`, { method: 'POST' });
        }
        isRunning = !isRunning;
        updateStartButton();
        refreshData();
      } catch (error) {
        console.error('åˆ‡æ¢æ‰§è¡ŒçŠ¶æ€å¤±è´¥:', error);
      }
    }

    // æ›´æ–°å¼€å§‹æŒ‰é’®
    function updateStartButton() {
      const btn = document.getElementById('startBtn');
      if (isRunning) {
        btn.textContent = 'â¸ï¸ æš‚åœæ‰§è¡Œ';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-danger');
      } else {
        btn.textContent = 'â–¶ï¸ å¼€å§‹æ‰§è¡Œ';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-success');
      }
    }

    // åˆ›å»ºæ£€æŸ¥ç‚¹
    async function createCheckpoint() {
      if (!currentTreeId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»»åŠ¡æ ‘');
        return;
      }

      const name = prompt('è¯·è¾“å…¥æ£€æŸ¥ç‚¹åç§°:');
      if (!name) return;

      try {
        await fetch(`${API_BASE}/time-travel/${currentTreeId}/checkpoints`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name }),
        });
        alert('æ£€æŸ¥ç‚¹åˆ›å»ºæˆåŠŸ!');
        refreshData();
      } catch (error) {
        console.error('åˆ›å»ºæ£€æŸ¥ç‚¹å¤±è´¥:', error);
        alert('åˆ›å»ºæ£€æŸ¥ç‚¹å¤±è´¥');
      }
    }

    // é€‰æ‹©ä»»åŠ¡
    function selectTask(taskId) {
      console.log('é€‰æ‹©ä»»åŠ¡:', taskId);
      // TODO: æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
    }

    // å›æ»šåˆ°æ£€æŸ¥ç‚¹
    async function rollbackTo(checkpointId) {
      if (!currentTreeId) return;

      if (!confirm('ç¡®å®šè¦å›æ»šåˆ°æ­¤æ£€æŸ¥ç‚¹å—? è¿™å°†æ’¤é”€ä¹‹åçš„æ‰€æœ‰æ›´æ”¹ã€‚')) {
        return;
      }

      try {
        await fetch(`${API_BASE}/time-travel/${currentTreeId}/rollback/${checkpointId}`, {
          method: 'POST',
        });
        alert('å›æ»šæˆåŠŸ!');
        refreshData();
      } catch (error) {
        console.error('å›æ»šå¤±è´¥:', error);
        alert('å›æ»šå¤±è´¥');
      }
    }
  </script>
</body>
</html>
