<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¶å…‰å€’æµ | Claude Code</title>
  <style>
    :root {
      --bg-primary: #1a1b26;
      --bg-secondary: #24283b;
      --bg-tertiary: #414868;
      --text-primary: #c0caf5;
      --text-secondary: #a9b1d6;
      --accent-blue: #7aa2f7;
      --accent-green: #9ece6a;
      --accent-red: #f7768e;
      --accent-yellow: #e0af68;
      --accent-purple: #bb9af7;
      --accent-cyan: #7dcfff;
      --border-color: #414868;
      --timeline-color: #7aa2f7;
      --branch-color: #9ece6a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* å¤´éƒ¨ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 28px;
      color: var(--accent-purple);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header h1::before {
      content: 'â°';
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-family: inherit;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: var(--bg-primary);
    }

    .btn-danger {
      background: var(--accent-red);
      color: var(--bg-primary);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--accent-blue);
      color: var(--accent-blue);
    }

    .btn:hover {
      opacity: 0.85;
      transform: translateY(-1px);
    }

    /* ä¸»å†…å®¹åŒº */
    .main-content {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 24px;
    }

    @media (max-width: 1000px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    /* å¡ç‰‡ */
    .card {
      background: var(--bg-secondary);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h3 {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-body {
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
    }

    /* æ—¶é—´çº¿å›¾ */
    .timeline-graph {
      position: relative;
      padding-left: 60px;
    }

    .timeline-row {
      position: relative;
      display: flex;
      align-items: flex-start;
      margin-bottom: 8px;
      min-height: 60px;
    }

    .timeline-graph-column {
      position: absolute;
      left: 0;
      top: 0;
      width: 50px;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Git é£æ ¼å›¾å½¢ */
    .graph-line {
      position: absolute;
      width: 2px;
      background: var(--timeline-color);
      left: 50%;
      transform: translateX(-50%);
    }

    .graph-line.main {
      background: var(--timeline-color);
    }

    .graph-line.branch {
      background: var(--branch-color);
    }

    .graph-node {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--bg-primary);
      border: 3px solid var(--timeline-color);
      left: 50%;
      top: 20px;
      transform: translateX(-50%);
      z-index: 10;
      cursor: pointer;
      transition: all 0.2s;
    }

    .graph-node:hover {
      transform: translateX(-50%) scale(1.3);
    }

    .graph-node.global {
      border-color: var(--accent-purple);
      background: var(--accent-purple);
    }

    .graph-node.task {
      border-color: var(--accent-cyan);
    }

    .graph-node.current {
      border-color: var(--accent-green);
      background: var(--accent-green);
      width: 18px;
      height: 18px;
    }

    .graph-node.branch-point {
      border-color: var(--branch-color);
    }

    /* è¿æ¥çº¿ */
    .graph-connector {
      position: absolute;
      height: 2px;
      background: var(--branch-color);
      top: 27px;
    }

    /* æ£€æŸ¥ç‚¹å†…å®¹ */
    .checkpoint-content {
      flex: 1;
      background: var(--bg-tertiary);
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .checkpoint-content:hover {
      background: var(--bg-secondary);
      transform: translateX(4px);
    }

    .checkpoint-content.selected {
      border-left-color: var(--accent-blue);
      background: var(--bg-secondary);
    }

    .checkpoint-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .checkpoint-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .checkpoint-type {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .checkpoint-type.global {
      background: var(--accent-purple);
      color: var(--bg-primary);
    }

    .checkpoint-type.task {
      background: var(--accent-cyan);
      color: var(--bg-primary);
    }

    .checkpoint-meta {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .checkpoint-time {
      margin-right: 16px;
    }

    /* è¯¦æƒ…é¢æ¿ */
    .detail-panel {
      display: none;
    }

    .detail-panel.active {
      display: block;
    }

    .detail-section {
      margin-bottom: 20px;
    }

    .detail-section h4 {
      font-size: 13px;
      color: var(--accent-cyan);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* å·®å¼‚è§†å›¾ */
    .diff-view {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 16px;
      font-family: 'SF Mono', monospace;
      font-size: 12px;
      overflow-x: auto;
    }

    .diff-line {
      padding: 2px 8px;
      white-space: pre;
    }

    .diff-line.added {
      background: rgba(158, 206, 106, 0.2);
      color: var(--accent-green);
    }

    .diff-line.removed {
      background: rgba(247, 118, 142, 0.2);
      color: var(--accent-red);
    }

    .diff-line.context {
      color: var(--text-secondary);
    }

    /* ä»»åŠ¡çŠ¶æ€å¿«ç…§ */
    .task-snapshot {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .task-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
    }

    .task-status-icon {
      font-size: 14px;
    }

    .task-name {
      flex: 1;
      font-size: 13px;
    }

    .task-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--bg-secondary);
    }

    .task-status.passed { background: var(--accent-green); color: var(--bg-primary); }
    .task-status.failed { background: var(--accent-red); color: var(--bg-primary); }
    .task-status.pending { background: var(--bg-tertiary); }
    .task-status.running { background: var(--accent-yellow); color: var(--bg-primary); }

    /* åˆ†æ”¯ç®¡ç† */
    .branch-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .branch-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border-radius: 6px;
    }

    .branch-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }

    .branch-icon {
      color: var(--branch-color);
    }

    .branch-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .branch-status.active {
      background: var(--accent-green);
      color: var(--bg-primary);
    }

    /* æ“ä½œæŒ‰é’® */
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .action-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .action-btn.rollback {
      background: var(--accent-red);
      color: var(--bg-primary);
    }

    .action-btn.branch {
      background: var(--branch-color);
      color: var(--bg-primary);
    }

    .action-btn.compare {
      background: var(--accent-blue);
      color: var(--bg-primary);
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* å¯¹è¯æ¡† */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--border-color);
    }

    .modal-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--accent-purple);
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-body input {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
      margin-top: 8px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <header class="header">
      <h1>æ—¶å…‰å€’æµ</h1>
      <div class="header-actions">
        <button class="btn btn-outline" onclick="createGlobalCheckpoint()">
          ğŸ“ åˆ›å»ºæ£€æŸ¥ç‚¹
        </button>
        <button class="btn btn-primary" onclick="refreshTimeline()">
          ğŸ”„ åˆ·æ–°
        </button>
      </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <!-- å·¦ä¾§ï¼šæ—¶é—´çº¿å›¾ -->
      <div class="card">
        <div class="card-header">
          <h3>ğŸ“Š æ—¶é—´çº¿</h3>
          <span id="checkpoint-count">0 ä¸ªæ£€æŸ¥ç‚¹</span>
        </div>
        <div class="card-body">
          <div id="timeline-graph" class="timeline-graph">
            <div class="empty-state">
              <div class="empty-state-icon">â³</div>
              <p>æš‚æ— æ£€æŸ¥ç‚¹</p>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šè¯¦æƒ…é¢æ¿ -->
      <div class="card">
        <div class="card-header">
          <h3>ğŸ“‹ æ£€æŸ¥ç‚¹è¯¦æƒ…</h3>
          <span id="selected-checkpoint-name">æœªé€‰æ‹©</span>
        </div>
        <div class="card-body">
          <!-- æœªé€‰æ‹©æ—¶ -->
          <div id="no-selection" class="detail-panel active">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ‘ˆ</div>
              <p>é€‰æ‹©ä¸€ä¸ªæ£€æŸ¥ç‚¹æŸ¥çœ‹è¯¦æƒ…</p>
            </div>
          </div>

          <!-- æ£€æŸ¥ç‚¹è¯¦æƒ… -->
          <div id="checkpoint-detail" class="detail-panel">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="detail-section">
              <h4>ğŸ“Œ åŸºæœ¬ä¿¡æ¯</h4>
              <div id="checkpoint-info" class="diff-view">
                <p>åç§°ï¼š<span id="detail-name">-</span></p>
                <p>ç±»å‹ï¼š<span id="detail-type">-</span></p>
                <p>æ—¶é—´ï¼š<span id="detail-time">-</span></p>
                <p>çŠ¶æ€ï¼š<span id="detail-status">-</span></p>
              </div>
            </div>

            <!-- ä»»åŠ¡çŠ¶æ€å¿«ç…§ -->
            <div class="detail-section">
              <h4>ğŸ“‹ ä»»åŠ¡çŠ¶æ€å¿«ç…§</h4>
              <div id="task-snapshot" class="task-snapshot">
                <!-- åŠ¨æ€å¡«å…… -->
              </div>
            </div>

            <!-- æ–‡ä»¶å˜æ›´ -->
            <div class="detail-section">
              <h4>ğŸ“ æ–‡ä»¶å˜æ›´</h4>
              <div id="file-changes" class="diff-view">
                <!-- åŠ¨æ€å¡«å…… -->
              </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
              <button class="action-btn rollback" onclick="rollbackToSelected()">
                âª å›æ»šåˆ°æ­¤å¤„
              </button>
              <button class="action-btn branch" onclick="createBranchFromSelected()">
                ğŸŒ¿ åˆ›å»ºåˆ†æ”¯
              </button>
              <button class="action-btn compare" onclick="compareWithCurrent()">
                ğŸ“Š ä¸å½“å‰å¯¹æ¯”
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åˆ†æ”¯ç®¡ç†åŒº -->
    <div class="card" style="margin-top: 24px;">
      <div class="card-header">
        <h3>ğŸŒ¿ åˆ†æ”¯ç®¡ç†</h3>
        <span id="branch-count">0 ä¸ªåˆ†æ”¯</span>
      </div>
      <div class="card-body">
        <div id="branch-list" class="branch-list">
          <div class="branch-item">
            <div class="branch-name">
              <span class="branch-icon">â—</span>
              main
            </div>
            <span class="branch-status active">å½“å‰</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ›å»ºåˆ†æ”¯å¯¹è¯æ¡† -->
  <div class="modal" id="branch-modal">
    <div class="modal-content">
      <div class="modal-header">ğŸŒ¿ åˆ›å»ºæ–°åˆ†æ”¯</div>
      <div class="modal-body">
        <label>åˆ†æ”¯åç§°ï¼š</label>
        <input type="text" id="branch-name-input" placeholder="ä¾‹å¦‚ï¼šfeature-new-auth">
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeBranchModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="confirmCreateBranch()">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <!-- ç¡®è®¤å¯¹è¯æ¡† -->
  <div class="modal" id="confirm-modal">
    <div class="modal-content">
      <div class="modal-header" id="confirm-title">ç¡®è®¤æ“ä½œ</div>
      <div class="modal-body" id="confirm-body">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeConfirmModal()">å–æ¶ˆ</button>
        <button class="btn btn-danger" id="confirm-btn" onclick="confirmAction()">ç¡®è®¤</button>
      </div>
    </div>
  </div>

  <script>
    // çŠ¶æ€
    let checkpoints = [];
    let branches = [];
    let selectedCheckpoint = null;
    let currentTreeId = null;
    let pendingAction = null;

    // API åŸºç¡€è·¯å¾„
    const API_BASE = '/api/blueprint';

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // ä» URL è·å–ä»»åŠ¡æ ‘ ID
      const urlParams = new URLSearchParams(window.location.search);
      currentTreeId = urlParams.get('treeId') || 'current';
      loadTimeline();
    });

    // åŠ è½½æ—¶é—´çº¿
    async function loadTimeline() {
      try {
        const response = await fetch(`${API_BASE}/time-travel/${currentTreeId}/timeline`);
        const data = await response.json();

        if (data.success) {
          checkpoints = data.data.checkpoints || [];
          branches = data.data.branches || [];
          renderTimeline();
          renderBranches();
        } else {
          console.error('åŠ è½½æ—¶é—´çº¿å¤±è´¥:', data.error);
        }
      } catch (error) {
        console.error('ç½‘ç»œé”™è¯¯:', error);
      }
    }

    // æ¸²æŸ“æ—¶é—´çº¿å›¾ï¼ˆgit log --graph é£æ ¼ï¼‰
    function renderTimeline() {
      const container = document.getElementById('timeline-graph');
      document.getElementById('checkpoint-count').textContent = `${checkpoints.length} ä¸ªæ£€æŸ¥ç‚¹`;

      if (checkpoints.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">â³</div>
            <p>æš‚æ— æ£€æŸ¥ç‚¹</p>
          </div>
        `;
        return;
      }

      // ç”Ÿæˆ git é£æ ¼æ—¶é—´çº¿
      let html = '';

      checkpoints.forEach((cp, index) => {
        const isFirst = index === 0;
        const isLast = index === checkpoints.length - 1;
        const nodeClass = cp.type === 'global' ? 'global' : 'task';
        const currentClass = isFirst ? 'current' : '';

        html += `
          <div class="timeline-row" data-id="${cp.id}" onclick="selectCheckpoint('${cp.id}')">
            <div class="timeline-graph-column">
              ${!isFirst ? '<div class="graph-line main" style="top: 0; height: 27px;"></div>' : ''}
              <div class="graph-node ${nodeClass} ${currentClass}" title="${cp.name}"></div>
              ${!isLast ? '<div class="graph-line main" style="top: 27px; bottom: 0;"></div>' : ''}
            </div>
            <div class="checkpoint-content ${isFirst ? 'selected' : ''}">
              <div class="checkpoint-header">
                <span class="checkpoint-name">${cp.name}</span>
                <span class="checkpoint-type ${cp.type}">${cp.type === 'global' ? 'å…¨å±€' : 'ä»»åŠ¡'}</span>
              </div>
              <div class="checkpoint-meta">
                <span class="checkpoint-time">ğŸ• ${formatTime(cp.timestamp)}</span>
                <span class="checkpoint-files">ğŸ“ ${cp.codeChangesCount} ä¸ªæ–‡ä»¶å˜æ›´</span>
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
      if (checkpoints.length > 0) {
        selectCheckpoint(checkpoints[0].id);
      }
    }

    // æ¸²æŸ“åˆ†æ”¯åˆ—è¡¨
    function renderBranches() {
      const container = document.getElementById('branch-list');
      document.getElementById('branch-count').textContent = `${branches.length + 1} ä¸ªåˆ†æ”¯`;

      let html = `
        <div class="branch-item">
          <div class="branch-name">
            <span class="branch-icon">â—</span>
            main
          </div>
          <span class="branch-status active">å½“å‰</span>
        </div>
      `;

      branches.forEach(branch => {
        html += `
          <div class="branch-item">
            <div class="branch-name">
              <span class="branch-icon">â—‹</span>
              ${branch.name}
            </div>
            <span class="branch-status">${branch.status}</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // é€‰æ‹©æ£€æŸ¥ç‚¹
    async function selectCheckpoint(checkpointId) {
      // æ›´æ–° UI é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.checkpoint-content').forEach(el => {
        el.classList.remove('selected');
      });
      const row = document.querySelector(`[data-id="${checkpointId}"]`);
      if (row) {
        row.querySelector('.checkpoint-content').classList.add('selected');
      }

      // åŠ è½½æ£€æŸ¥ç‚¹è¯¦æƒ…
      try {
        const response = await fetch(`${API_BASE}/time-travel/${currentTreeId}/checkpoints/${checkpointId}`);
        const data = await response.json();

        if (data.success) {
          selectedCheckpoint = data.data;
          renderCheckpointDetail(selectedCheckpoint);
        }
      } catch (error) {
        console.error('åŠ è½½æ£€æŸ¥ç‚¹è¯¦æƒ…å¤±è´¥:', error);
      }
    }

    // æ¸²æŸ“æ£€æŸ¥ç‚¹è¯¦æƒ…
    function renderCheckpointDetail(detail) {
      document.getElementById('no-selection').classList.remove('active');
      document.getElementById('checkpoint-detail').classList.add('active');
      document.getElementById('selected-checkpoint-name').textContent = detail.checkpoint.name;

      // åŸºæœ¬ä¿¡æ¯
      document.getElementById('detail-name').textContent = detail.checkpoint.name;
      document.getElementById('detail-type').textContent = detail.checkpoint.type === 'global' ? 'å…¨å±€æ£€æŸ¥ç‚¹' : 'ä»»åŠ¡æ£€æŸ¥ç‚¹';
      document.getElementById('detail-time').textContent = formatTime(detail.checkpoint.timestamp);
      document.getElementById('detail-status').textContent = detail.checkpoint.status;

      // ä»»åŠ¡çŠ¶æ€å¿«ç…§ï¼ˆç®€åŒ–ç‰ˆï¼‰
      const snapshotContainer = document.getElementById('task-snapshot');
      if (detail.taskSnapshot && detail.taskSnapshot.length > 0) {
        snapshotContainer.innerHTML = detail.taskSnapshot.map(task => `
          <div class="task-item">
            <span class="task-status-icon">${getStatusIcon(task.status)}</span>
            <span class="task-name">${task.name}</span>
            <span class="task-status ${task.status}">${task.status}</span>
          </div>
        `).join('');
      } else {
        snapshotContainer.innerHTML = '<p style="color: var(--text-secondary);">æ— ä»»åŠ¡çŠ¶æ€å¿«ç…§</p>';
      }

      // æ–‡ä»¶å˜æ›´
      const changesContainer = document.getElementById('file-changes');
      if (detail.codeSnapshots && detail.codeSnapshots.length > 0) {
        changesContainer.innerHTML = detail.codeSnapshots.map(file => `
          <div class="diff-line context">ğŸ“„ ${file.filePath}</div>
        `).join('');
      } else {
        changesContainer.innerHTML = '<p>æ— æ–‡ä»¶å˜æ›´</p>';
      }
    }

    // å›æ»šåˆ°é€‰ä¸­æ£€æŸ¥ç‚¹
    function rollbackToSelected() {
      if (!selectedCheckpoint) return;

      showConfirm(
        'âš ï¸ ç¡®è®¤å›æ»š',
        `ç¡®å®šè¦å›æ»šåˆ°æ£€æŸ¥ç‚¹ "${selectedCheckpoint.checkpoint.name}" å—ï¼Ÿè¿™å°†æ’¤é”€ä¹‹åçš„æ‰€æœ‰æ›´æ”¹ã€‚`,
        async () => {
          try {
            const response = await fetch(`${API_BASE}/time-travel/${currentTreeId}/rollback`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                checkpointId: selectedCheckpoint.checkpoint.id,
                isGlobal: selectedCheckpoint.checkpoint.type === 'global',
              }),
            });
            const data = await response.json();
            if (data.success) {
              alert('å›æ»šæˆåŠŸï¼');
              loadTimeline();
            } else {
              alert('å›æ»šå¤±è´¥: ' + data.error);
            }
          } catch (error) {
            alert('æ“ä½œå¤±è´¥: ' + error.message);
          }
        }
      );
    }

    // ä»é€‰ä¸­æ£€æŸ¥ç‚¹åˆ›å»ºåˆ†æ”¯
    function createBranchFromSelected() {
      if (!selectedCheckpoint) return;
      document.getElementById('branch-modal').classList.add('active');
    }

    function closeBranchModal() {
      document.getElementById('branch-modal').classList.remove('active');
      document.getElementById('branch-name-input').value = '';
    }

    async function confirmCreateBranch() {
      const branchName = document.getElementById('branch-name-input').value.trim();
      if (!branchName) {
        alert('è¯·è¾“å…¥åˆ†æ”¯åç§°');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/time-travel/${currentTreeId}/branches`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            checkpointId: selectedCheckpoint.checkpoint.id,
            branchName,
          }),
        });
        const data = await response.json();
        if (data.success) {
          closeBranchModal();
          loadTimeline();
          alert(`åˆ†æ”¯ "${branchName}" åˆ›å»ºæˆåŠŸï¼`);
        } else {
          alert('åˆ›å»ºåˆ†æ”¯å¤±è´¥: ' + data.error);
        }
      } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + error.message);
      }
    }

    // ä¸å½“å‰çŠ¶æ€å¯¹æ¯”
    async function compareWithCurrent() {
      if (!selectedCheckpoint) return;

      const currentId = checkpoints[0]?.id;
      if (!currentId || currentId === selectedCheckpoint.checkpoint.id) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªéå½“å‰çš„æ£€æŸ¥ç‚¹è¿›è¡Œå¯¹æ¯”');
        return;
      }

      try {
        const response = await fetch(
          `${API_BASE}/time-travel/${currentTreeId}/compare?from=${selectedCheckpoint.checkpoint.id}&to=${currentId}`
        );
        const data = await response.json();
        if (data.success) {
          // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
          const result = data.data;
          let message = `å¯¹æ¯”ç»“æœï¼š\n\n`;
          message += `æ—¶é—´è·¨åº¦: ${formatDuration(result.timeElapsed)}\n`;
          message += `ä»»åŠ¡å˜æ›´: ${result.taskChanges.length} é¡¹\n`;
          message += `æ–‡ä»¶å˜æ›´: ${result.codeChanges.length} ä¸ªæ–‡ä»¶\n`;
          alert(message);
        } else {
          alert('å¯¹æ¯”å¤±è´¥: ' + data.error);
        }
      } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + error.message);
      }
    }

    // åˆ›å»ºå…¨å±€æ£€æŸ¥ç‚¹
    async function createGlobalCheckpoint() {
      const name = prompt('è¯·è¾“å…¥æ£€æŸ¥ç‚¹åç§°ï¼š');
      if (!name) return;

      try {
        const response = await fetch(`${API_BASE}/time-travel/${currentTreeId}/checkpoints`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, isGlobal: true }),
        });
        const data = await response.json();
        if (data.success) {
          loadTimeline();
          alert('æ£€æŸ¥ç‚¹åˆ›å»ºæˆåŠŸï¼');
        } else {
          alert('åˆ›å»ºå¤±è´¥: ' + data.error);
        }
      } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + error.message);
      }
    }

    // åˆ·æ–°æ—¶é—´çº¿
    function refreshTimeline() {
      loadTimeline();
    }

    // ç¡®è®¤å¯¹è¯æ¡†
    function showConfirm(title, body, callback) {
      document.getElementById('confirm-title').textContent = title;
      document.getElementById('confirm-body').textContent = body;
      pendingAction = callback;
      document.getElementById('confirm-modal').classList.add('active');
    }

    function closeConfirmModal() {
      document.getElementById('confirm-modal').classList.remove('active');
      pendingAction = null;
    }

    function confirmAction() {
      if (pendingAction) {
        pendingAction();
      }
      closeConfirmModal();
    }

    // å·¥å…·å‡½æ•°
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString('zh-CN');
    }

    function formatDuration(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days} å¤© ${hours % 24} å°æ—¶`;
      if (hours > 0) return `${hours} å°æ—¶ ${minutes % 60} åˆ†é’Ÿ`;
      if (minutes > 0) return `${minutes} åˆ†é’Ÿ`;
      return `${seconds} ç§’`;
    }

    function getStatusIcon(status) {
      const icons = {
        passed: 'âœ…',
        failed: 'âŒ',
        pending: 'â³',
        running: 'ğŸ”„',
        test_failed: 'âŒ',
        approved: 'âœ…',
      };
      return icons[status] || 'â³';
    }
  </script>
</body>
</html>
